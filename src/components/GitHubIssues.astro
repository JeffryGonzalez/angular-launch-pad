---
interface Props {
	owner: string;
	repo: string;
}

const { owner, repo } = Astro.props;

// Function to determine if label needs light or dark text
function getContrastColor(hexColor: string): string {
	const r = parseInt(hexColor.substr(0, 2), 16);
	const g = parseInt(hexColor.substr(2, 2), 16);
	const b = parseInt(hexColor.substr(4, 2), 16);
	const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
	return luminance > 0.5 ? '#000000' : '#ffffff';
}

interface GitHubIssue {
	id: number;
	number: number;
	title: string;
	html_url: string;
	labels: Array<{
		name: string;
		color: string;
	}>;
	assignee: {
		login: string;
		html_url: string;
	} | null;
	assignees: Array<{
		login: string;
		html_url: string;
	}>;
}

let issues: GitHubIssue[] = [];
let error: string | null = null;
let fetchedAt: string = new Date().toISOString();

try {
	const headers: Record<string, string> = {
		'Accept': 'application/vnd.github.v3+json',
		'User-Agent': 'Astro-Site'
	};
	
	// Use GITHUB_TOKEN if available for higher rate limits
	if (import.meta.env.GITHUB_TOKEN) {
		headers['Authorization'] = `token ${import.meta.env.GITHUB_TOKEN}`;
	}

	const response = await fetch(
		`https://api.github.com/repos/${owner}/${repo}/issues?state=open&per_page=100`,
		{ headers }
	);

	if (!response.ok) {
		throw new Error(`GitHub API returned ${response.status}`);
	}

	const data = await response.json();
	// Filter out pull requests (they show up in issues endpoint)
	issues = data.filter((issue: GitHubIssue & { pull_request?: unknown }) => !issue.pull_request);
} catch (e) {
	error = e instanceof Error ? e.message : 'Failed to fetch issues';
	console.error('Error fetching GitHub issues:', error);
}
---

<div class="github-issues">
	<div class="issues-header">
		<div class="header-title">
			<h4>Open GitHub Issues</h4>
			<div class="header-actions">
				<a href={`https://github.com/${owner}/${repo}/issues`} target="_blank" rel="noopener noreferrer" class="view-all-link">
					View all issues →
				</a>
				<a href={`https://github.com/${owner}/${repo}/issues/new`} target="_blank" rel="noopener noreferrer" class="new-issue-button">
					+ Add New Issue
				</a>
			</div>
		</div>
		<span class="issue-count">{issues.length} {issues.length === 1 ? 'issue' : 'issues'}</span>
	</div>

	{error && (
		<div class="error-message">
			<p>⚠️ Could not fetch issues: {error}</p>
			<p class="error-hint">Check the repository name or try setting a GITHUB_TOKEN environment variable.</p>
		</div>
	)}

	{!error && issues.length === 0 && (
		<div class="no-issues">
			<p>✓ No open issues!</p>
		</div>
	)}

	{!error && issues.length > 0 && (
		<ul class="issues-list">
			{issues.map((issue) => (
				<li class="issue-item">
					<div class="issue-header">
						<a href={issue.html_url} target="_blank" rel="noopener noreferrer" class="issue-title">
							#{issue.number} {issue.title}
						</a>
					</div>
					<div class="issue-meta">
						{issue.labels.length > 0 && (
							<div class="issue-labels">
								{issue.labels.map((label) => (
									<span 
										class="issue-label" 
										style={`background-color: #${label.color}; color: ${getContrastColor(label.color)};`}
									>
										{label.name}
									</span>
								))}
							</div>
						)}
						{issue.assignees.length > 0 && (
							<div class="issue-assignees">
								<span class="assignee-label">Assigned to:</span>
								{issue.assignees.map((assignee, index) => (
									<>
										<a href={assignee.html_url} target="_blank" rel="noopener noreferrer" class="assignee-link">
											@{assignee.login}
										</a>
										{index < issue.assignees.length - 1 && <span>, </span>}
									</>
								))}
							</div>
						)}
					</div>
				</li>
			))}
		</ul>
	)}

	<div class="fetch-timestamp">
		Last updated: {new Date(fetchedAt).toLocaleString()}
	</div>
</div>

<style>
	.github-issues {
		margin: 2rem 0;
		padding: 1.5rem;
		background: var(--sl-color-gray-6);
		border-radius: 0.5rem;
		border: 1px solid var(--sl-color-gray-5);
	}

	.issues-header {
		display: flex;
		align-items: center;
		justify-content: space-between;
		margin-bottom: 1rem;
		padding-bottom: 0.75rem;
		border-bottom: 2px solid var(--sl-color-gray-5);
	}

	.header-title {
		display: flex;
		flex-direction: column;
		gap: 0.25rem;
	}

	.header-actions {
		display: flex;
		align-items: center;
		gap: 0.75rem;
		flex-wrap: wrap;
	}

	.issues-header h4 {
		margin: 0;
		font-size: 1.25rem;
		color: var(--sl-color-text);
	}

	.view-all-link {
		font-size: 0.8125rem;
		color: var(--sl-color-text-accent);
		text-decoration: none;
		font-weight: 500;
		transition: color 0.2s ease;
	}

	.view-all-link:hover {
		color: var(--sl-color-text-accent);
		text-decoration: underline;
	}

	.new-issue-button {
		display: inline-flex;
		align-items: center;
		font-size: 0.8125rem;
		padding: 0.375rem 0.75rem;
		background: var(--sl-color-text-accent);
		color: white;
		text-decoration: none;
		font-weight: 600;
		border-radius: 0.375rem;
		transition: opacity 0.2s ease;
	}

	.new-issue-button:hover {
		opacity: 0.9;
	}

	.issue-count {
		font-size: 0.875rem;
		padding: 0.25rem 0.75rem;
		background: var(--sl-color-gray-5);
		border-radius: 1rem;
		font-weight: 600;
		color: var(--sl-color-text);
	}

	.error-message {
		padding: 1rem;
		background: rgba(239, 68, 68, 0.1);
		border: 1px solid rgb(239, 68, 68);
		border-radius: 0.375rem;
		color: var(--sl-color-text);
	}

	.error-message p {
		margin: 0.5rem 0;
	}

	.error-hint {
		font-size: 0.875rem;
		opacity: 0.8;
	}

	.no-issues {
		padding: 2rem;
		text-align: center;
		color: rgb(34, 197, 94);
		font-size: 1.125rem;
		font-weight: 500;
	}

	.no-issues p {
		margin: 0;
	}

	.issues-list {
		list-style: none;
		padding: 0;
		margin: 0;
	}

	.issue-item {
		padding: 1rem;
		margin-bottom: 1rem;
		background: var(--sl-color-bg);
		border-radius: 0.375rem;
		border: 1px solid var(--sl-color-gray-5);
		transition: box-shadow 0.2s ease;
	}

	.issue-item:hover {
		box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
	}

	.issue-item:last-child {
		margin-bottom: 0;
	}

	.issue-header {
		margin-bottom: 0.75rem;
	}

	.issue-title {
		font-weight: 600;
		color: var(--sl-color-text);
		text-decoration: none;
		display: inline-flex;
		align-items: center;
		gap: 0.375rem;
	}

	.issue-title:hover {
		color: var(--sl-color-text-accent);
		text-decoration: underline;
	}

	.issue-meta {
		display: flex;
		flex-direction: column;
		gap: 0.5rem;
	}

	.issue-labels {
		display: flex;
		flex-wrap: wrap;
		gap: 0.375rem;
	}

	.issue-label {
		font-size: 0.75rem;
		padding: 0.125rem 0.5rem;
		border-radius: 0.25rem;
		font-weight: 500;
		white-space: nowrap;
	}

	.issue-assignees {
		display: flex;
		align-items: center;
		gap: 0.375rem;
		font-size: 0.875rem;
		color: var(--sl-color-gray-2);
	}

	.assignee-label {
		font-weight: 500;
	}

	.assignee-link {
		color: var(--sl-color-text-accent);
		text-decoration: none;
		font-family: monospace;
	}

	.assignee-link:hover {
		text-decoration: underline;
	}

	.fetch-timestamp {
		margin-top: 1rem;
		padding-top: 1rem;
		border-top: 1px solid var(--sl-color-gray-5);
		font-size: 0.75rem;
		color: var(--sl-color-gray-3);
		text-align: right;
	}

	@media (prefers-color-scheme: dark) {
		.github-issues {
			background: var(--sl-color-gray-6);
			border-color: var(--sl-color-gray-5);
		}

		.issue-item:hover {
			box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
		}
	}

	:root[data-theme='dark'] .github-issues {
		background: var(--sl-color-gray-6);
		border-color: var(--sl-color-gray-5);
	}

	:root[data-theme='dark'] .issue-item:hover {
		box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
	}
</style>
